
DROP TABLE IF EXISTS hashs;
DROP TABLE IF EXISTS users;

Create Table  users (
    user_account_id BIGINT GENERATED ALWAYS AS IDENTITY,
    username VARCHAR(128),
    passphrase VARCHAR(128) NOT NULL,
    email VARCHAR(128) UNIQUE NOT NULL,
    first_name VARCHAR(128),
    last_name VARCHAR(128), 
    authorization_level VARCHAR(50) NOT NULL,
    enabled bit NOT NULL,
    confirmed bit NOT NULL,
	PRIMARY KEY(user_account_id)
  );

CREATE TABLE hashs (
	user_account_id BIGINT NULL,
	user_hash VARCHAR(128) PRIMARY KEY,
	CONSTRAINT hash_fk FOREIGN KEY(user_account_id) REFERENCES users(user_account_id)
);

CREATE PROCEDURE CreateAccount (
	procedureEmail VARCHAR(128),
	procedurePassphrase VARCHAR(128),
	procedureAuthorizationLevel VARCHAR(50),
	procedureEnabled bit,
	procedureConfirmed bit,
	procedureHash VARCHAR(128)
)
language plpgsql
as $$
DECLARE procedure_id BIGINT;
begin	
	
	INSERT INTO users (email, passphrase, authorization_level, enabled, confirmed)
		VALUES(procedureEmail, procedurePassphrase, procedureAuthorizationLevel, procedureEnabled, procedureConfirmed) RETURNING 
		user_account_id as procedure_id;
	INSERT INTO hashs(user_account_id, user_hash)
		VALUES(procedure_id, procedureHash);
END;$$